<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CF Durable Object Interval Tests</title>
  </head>
  <body>
    <h1>CF Durable Object Interval Tests</h1>
    <div>
      <p>
        Test if setInterval loses time.
      </p>
            <form action="" method="get">
        <p>Select test:</p>
        <input
          type="radio"
          id="test-do-websocket"
          name="test"
          value="do-websocket"
        />
        <label for="do-websocket">do-websocket</label>

        <p>Select work per request/message:</p>
        <input type="radio" id="work-0" name="work" value="0" />
        <label for="work-0">0</label>
        <input type="radio" id="work-100" name="work" value="100" />
        <label for="work-100">100</label>
        <input type="radio" id="work-1000" name="work" value="1000" />
        <label for="work-1000">1000</label>
        <input type="radio" id="work-10000" name="work" value="10000" />
        <label for="work-10000">10000</label>
        <input type="radio" id="work-100000" name="work" value="100000" />
        <label for="work-100000">100000</label>

        <p></p>
        <br /><input type="submit" value="Submit" />
      </form>
    <pre id="log"></pre>

    <script>
      const DEFAULT_TEST_CASE = "do-websocket";
      const DEFAULT_WORK = 0;
      const params = new URL(location.href).searchParams;
      const testCase = params.get("test") ?? DEFAULT_TEST_CASE;
      const work = params.get("work") ?? DEFAULT_WORK;

      document.getElementById(`test-${testCase}`).checked = true;
      document.getElementById(`work-${work}`).checked = true;

      const logDiv = document.getElementById("log");
      function log(...msgParts) {
        console.log(...msgParts);
        const msgDiv = document.createElement("div");
        msgDiv.innerText = msgParts.join(" ");
        logDiv.prepend(msgDiv);
      }

      function logResponse(responseData, lastServerTimestamp, timestamp, lastTimestamp) {
        const {i, serverTimestamp, serverID} = responseData;
        log(
          "Interval test",
          "| serverID",
          serverID,
          "| i",
          i.toString().padStart(3),
          "| timestamp - lastTimestamp",
          (timestamp - lastTimestamp).toString().padStart(5),
          "| timestamp - serverTimestamp",
          (timestamp - serverTimestamp).toString().padStart(5),
          "| serverTimestamp - lastServerTimestamp",
          (serverTimestamp - lastServerTimestamp).toString().padStart(5),
          "| timestamp",
          timestamp,
          "| lastTimestamp",
          lastTimestamp,
          "| serverTimestamp",
          serverTimestamp,
          "| lastServerTimestamp",
          lastServerTimestamp,
        );
      }
      
      function testDoWebSocket() {
        const url = new URL(location.href);
        url.protocol = url.protocol === "https:" ? "wss:" : "ws:";
        url.pathname = `/do-websocket`;
        url.search = '';
        url.searchParams.set('work', work);
        const ws = new WebSocket(url.toString());
        let lastTimestamp = 0;
        let lastServerTimestamp = 0;
        ws.addEventListener("message", async (e) => {
          if (e.data === "connected") {
            log('Connected');
            lastTimestamp = Date.now();
            lastServerTimestamp = lastTimestamp;
          } else if (typeof e.data === "string") {
            const timestamp = Date.now();
            const data = JSON.parse(e.data);
            logResponse(data, lastServerTimestamp, timestamp, lastTimestamp);
            lastTimestamp = timestamp;
            lastServerTimestamp = data.serverTimestamp;
          }
        });
        ws.addEventListener("close", async (e) => {
          log("web socket close", e);
        });
      }
      testDoWebSocket();
    </script>
  </body>
</html>
